## $(web_server_vars.conf[site_data][guac][site_file]) is managed by CFEngine v$(sys.cf_version) at $(sys.policy_hub)
## Support for $(config_login_banner.support)

<Directory $(web_server_vars.conf[site_data][guac][document_root])>
  AllowOverride All
  Options Indexes FollowSymLinks Includes ExecCGI
  Order allow,deny
  Allow from all
  Require all granted
</Directory>		    

<VirtualHost *:80>
    ServerName $(web_server_vars.conf[site_data][guac][domain_hostname]):80

    ## redirect traffic from 80 to 443, and also from / to /guacamole/
    Redirect permanent / https://$(web_server_vars.conf[site_data][guac][domain_hostname])/guacamole/
    Redirect permanent /guacamole https://$(web_server_vars.conf[site_data][guac][domain_hostname])/guacamole/
    
    ServerAlias $(web_server_vars.conf[site_data][guac][domain_hostname])
</VirtualHost>

## IP ADDRESS?
# <VirtualHost 156.26.250.93:443>
# <VirtualHost $(sys.ipv4):443>

<IfModule mod_ssl.c>
  <VirtualHost *:443>
    # ServerName $(web_server_vars.conf[site_data][guac][domain_hostname]):443
    ServerName $(web_server_vars.conf[site_data][guac][domain_hostname])
    ServerAdmin $(web_server_vars.conf[apache_serveradmin_email])

    ProxyPreserveHost On

    ## redirect traffic from / to /guacamole/
    Redirect permanent / https://$(web_server_vars.conf[site_data][guac][domain_hostname])/guacamole/

    DocumentRoot $(web_server_vars.conf[site_data][guac][document_root])

    ## Enable SSL Engine, set certbot certificate paths, and include certbot SSL options
    SSLEngine on
    SSLCertificateFile $(web_server_vars.conf[certbot_cert_dir])/$(web_server_vars.conf[site_data][guac][domain_hostname])/$(web_server_vars.conf[certbot_cert_chain_file])
    SSLCertificateKeyFile $(web_server_vars.conf[certbot_cert_dir])/$(web_server_vars.conf[site_data][guac][domain_hostname])/$(web_server_vars.conf[certbot_cert_key_file])

    Include $(web_server_vars.conf[certbot_include_path])

    # COMMENTED OUT: self-signed (snakeoil) certificate
    # SSLCertificateFile    /etc/ssl/certs/ssl-cert-snakeoil.pem
    # SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
# set up reverse proxy for http requests

<Location /guacamole/>
  # <Location />
      Order allow,deny
      Allow from all
      ProxyPass http://localhost:8080/guacamole/ max=20 flushpackets=on
      ProxyPassReverse http://localhost:8080/guacamole/
      ProxyPassReverseCookiePath /guacamole/ /
      SetEnvIf Request_URI "^/guacamole/tunnel" dontlog
  </Location>

# set up reverse proxy for websocket tunnel connections
  <Location /guacamole/websocket-tunnel>
  # <Location /websocket-tunnel>
      Order allow,deny
      Allow from all
      ProxyPass ws://localhost:8080/guacamole/websocket-tunnel
      ProxyPassReverse ws://localhost:8080/guacamole/websocket-tunnel
    </Location>

  </VirtualHost>
</IfModule>


# set custom log for logging guacamole data
CustomLog $(web_server_vars.conf[site_data][guac][custom_apache_log]) common env=!dontlog
